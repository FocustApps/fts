{% block content %}
<div class="container">
    <button class="btn btn-sm btn-primary" hx-get={{ url_for(view_url) }} hx-target="#pageContent" hx-swap="innerHTML">
        Back
    </button>
    <section style="width: 40vw;">
        <div id="form-messages"></div>
        <form id="createPageForm">
            <h3>Add Page</h3>
            <div class="form-group mb-3">
                <label for="page_name" class="form-label">Page Name:</label>
                <input type="text" id="page_name" name="page_name" class="form-control" required
                    placeholder="Enter page name">
            </div>
            <div class="form-group mb-3">
                <label for="page_url" class="form-label">Page URL:</label>
                <input type="url" id="page_url" name="page_url" class="form-control" required
                    placeholder="https://example.com/page">
            </div>
            <div class="form-group mb-3">
                <label for="environments" class="form-label">Environments:</label>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="dev" id="env_dev" name="environments">
                    <label class="form-check-label" for="env_dev">Development</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="staging" id="env_staging"
                        name="environments">
                    <label class="form-check-label" for="env_staging">Staging</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="prod" id="env_prod" name="environments">
                    <label class="form-check-label" for="env_prod">Production</label>
                </div>
            </div>
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">Create Page</button>
                <button type="button" class="btn btn-secondary" hx-get={{ url_for(view_url) }} hx-target="#pageContent"
                    hx-swap="innerHTML">Cancel</button>
            </div>
        </form>
        <div class="mt-3">
            <small class="text-muted">
                <strong>Note:</strong> After creating the page, you can add identifiers to it from the page view.
            </small>
        </div>
    </section>
</div>

<script>
    // Handle form submission to send JSON
    document.getElementById('createPageForm').addEventListener('submit', function (evt) {
        evt.preventDefault(); // Prevent default form submission

        const formData = new FormData(evt.target);
        const environments = [];
        formData.getAll('environments').forEach(env => environments.push(env));

        const data = {
            id: null, // Will be set by backend
            page_name: formData.get('page_name'),
            page_url: formData.get('page_url'),
            created_at: new Date().toISOString(),
            identifiers: [], // Empty initially
            environments: environments
        };

        // Use fetch to send JSON properly
        fetch('/v1/api/pages/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'same-origin', // Include cookies and authentication
            body: JSON.stringify(data)
        })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Request failed with status: ' + response.status);
                }
            })
            .then(result => {
                // Handle success
                document.getElementById('form-messages').innerHTML = `
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <strong>Success!</strong> Page created successfully! Redirecting to pages list...
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
                document.getElementById('createPageForm').reset();
                setTimeout(() => {
                    htmx.ajax('GET', '{{ url_for(view_url) }}', { target: '#pageContent', swap: 'innerHTML' });
                }, 2000);
            })
            .catch(error => {
                // Handle error
                document.getElementById('form-messages').innerHTML = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <strong>Error!</strong> Failed to create page: ${error.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            });
    });
</script>

{% endblock %}