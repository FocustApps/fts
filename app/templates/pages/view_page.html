<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Page Details</h3>
        <div>
            <button class="btn btn-sm btn-secondary" hx-get="{{ url_for('get_pages') }}" hx-target="#pageContent"
                hx-swap="innerHTML" type="button">Back to Pages</button>
            <button class="btn btn-sm btn-warning" hx-get="{{ url_for('edit_page', record_id=page.id) }}"
                hx-target="#pageContent" hx-swap="innerHTML" type="button">Edit Page</button>
        </div>
    </div>

    <!-- Page Information -->
    <div class="card mb-4">
        <div class="card-body">
            <dl class="row">
                <dt class="col-sm-3">ID:</dt>
                <dd class="col-sm-9">{{ page.id }}</dd>

                <dt class="col-sm-3">Page Name:</dt>
                <dd class="col-sm-9">{{ page.page_name }}</dd>

                <dt class="col-sm-3">Page URL:</dt>
                <dd class="col-sm-9">
                    <a href="{{ page.page_url }}" target="_blank" class="text-decoration-none">
                        {{ page.page_url }} <i class="bi bi-external-link"></i>
                    </a>
                </dd>

                <dt class="col-sm-3">Environments:</dt>
                <dd class="col-sm-9">{{ page.environments }}</dd>

                <dt class="col-sm-3">Created:</dt>
                <dd class="col-sm-9">{{ page.created_at }}</dd>

                <dt class="col-sm-3">Identifiers:</dt>
                <dd class="col-sm-9">{{ page.identifier_count }} identifier(s)</dd>
            </dl>
        </div>
    </div>

    <!-- Identifiers Section -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Page Identifiers</h5>
            <a href="/v1/identifiers/new/?page_id={{ page.id }}" class="btn btn-sm btn-success"
                hx-get="/v1/identifiers/new/?page_id={{ page.id }}" hx-target="#pageContent" hx-swap="innerHTML">
                <i class="bi bi-plus-circle"></i> Add Identifier
            </a>
        </div>
        <div class="card-body">
            {% if identifiers %}
            <div id="identifiers-messages"></div>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Element Name</th>
                            <th>Strategy</th>
                            <th>Query</th>
                            <th>Action</th>
                            <th>Environments</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for identifier in identifiers %}
                        <tr id="identifier-row-{{ identifier.id }}">
                            <td>
                                <strong>{{ identifier.element_name }}</strong>
                            </td>
                            <td>
                                <span class="badge bg-primary">{{ identifier.locator_strategy }}</span>
                            </td>
                            <td>
                                <code class="small" title="{{ identifier.locator_query }}">
                                        {% if identifier.locator_query|length > 40 %}
                                            {{ identifier.locator_query[:40] }}...
                                        {% else %}
                                            {{ identifier.locator_query }}
                                        {% endif %}
                                    </code>
                            </td>
                            <td>
                                {% if identifier.action %}
                                <span class="badge bg-success">{{ identifier.action }}</span>
                                {% else %}
                                <span class="text-muted">â€”</span>
                                {% endif %}
                            </td>
                            <td>
                                <small>
                                    {% if identifier.environments %}
                                    {{ identifier.environments|join(', ') }}
                                    {% else %}
                                    <span class="text-muted">None</span>
                                    {% endif %}
                                </small>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <a href="/v1/identifiers/{{ identifier.id }}" class="btn btn-outline-info btn-sm"
                                        hx-get="/v1/identifiers/{{ identifier.id }}" hx-target="#pageContent"
                                        hx-swap="innerHTML" title="View Details">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a href="/v1/identifiers/{{ identifier.id }}/edit"
                                        class="btn btn-outline-warning btn-sm"
                                        hx-get="/v1/identifiers/{{ identifier.id }}/edit" hx-target="#pageContent"
                                        hx-swap="innerHTML" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <button class="btn btn-outline-danger btn-sm"
                                        hx-post="/v1/identifiers/{{ identifier.id }}/delete"
                                        hx-target="#identifiers-messages" hx-swap="innerHTML"
                                        hx-confirm="Are you sure you want to delete the identifier '{{ identifier.element_name }}'?"
                                        title="Delete">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-4">
                <i class="bi bi-search display-1 text-muted"></i>
                <h5 class="mt-3 text-muted">No identifiers found</h5>
                <p class="text-muted">This page doesn't have any identifiers yet.</p>
                <a href="/v1/identifiers/new/?page_id={{ page.id }}" class="btn btn-primary"
                    hx-get="/v1/identifiers/new/?page_id={{ page.id }}" hx-target="#pageContent" hx-swap="innerHTML">
                    <i class="bi bi-plus-circle"></i> Add First Identifier
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Delete Page Section -->
    <div class="mt-4">
        <div id="delete-page-messages"></div>
        <button class="btn btn-danger" hx-delete="/v1/api/pages/{{ page.id }}" hx-target="#delete-page-messages"
            hx-swap="innerHTML" hx-confirm="Are you sure you want to delete this page and all its identifiers?">
            <i class="bi bi-trash"></i> Delete Page
        </button>
    </div>
</div>

<script>
    // Handle successful identifier deletion
    document.body.addEventListener('htmx:afterSwap', function (evt) {
        if (evt.detail.target.id === 'identifiers-messages' && evt.detail.xhr.status === 200) {
            const content = evt.detail.target.innerHTML;
            if (content.includes('alert-success')) {
                // Refresh the page to update the identifier count and list
                setTimeout(() => {
                    htmx.ajax('GET', '{{ url_for("view_page", record_id=page.id) }}', { target: '#pageContent', swap: 'innerHTML' });
                }, 2000);
            }
        }

        // Handle page deletion
        if (evt.detail.target.id === 'delete-page-messages' && evt.detail.xhr.status === 200) {
            const content = evt.detail.target.innerHTML;
            if (content.includes('deleted successfully')) {
                evt.detail.target.innerHTML = `
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <strong>Success!</strong> Page deleted successfully! Redirecting to pages list...
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                setTimeout(() => {
                    htmx.ajax('GET', '{{ url_for("get_pages") }}', { target: '#pageContent', swap: 'innerHTML' });
                }, 2000);
            }
        }
    });

    // Add tooltips for truncated locator queries
    document.addEventListener('DOMContentLoaded', function () {
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
</script>